name: Deploy to Kubernetes and Trigger Promotion

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: wsl-runner

    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Deployment Target
        id: detect
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Default to no env
          ENV_FOLDER=""

          if echo "$CHANGED_FILES" | grep -q '^development/'; then
            ENV_FOLDER="development"
          elif echo "$CHANGED_FILES" | grep -q '^pre-releases/'; then
            ENV_FOLDER="pre-releases"
          elif echo "$CHANGED_FILES" | grep -q '^releases/'; then
            ENV_FOLDER="releases"
          elif echo "$CHANGED_FILES" | grep -q '^base/'; then
            # If only base changed â†’ deployment applies to development env by default (or you can change this)
            ENV_FOLDER="development"
          fi

          if [ -z "$ENV_FOLDER" ]; then
            echo "No deployable folder changed."
            exit 0
          fi

          echo "kustomize_path=./$ENV_FOLDER" >> $GITHUB_ENV
          echo "Detected environment overlay: $ENV_FOLDER"

      - name: Apply Manifest using Kustomize
        run: |
          echo "Deploying using: $kustomize_path"
          kustomize build "$kustomize_path" | kubectl apply -f -

      - name: Wait for Deployment to Stabilize
        run: |
          DEPLOYMENT_NAME=$(kubectl get deploy -o jsonpath='{.items[0].metadata.name}')
          echo "Waiting for deployment: $DEPLOYMENT_NAME"
          kubectl rollout status deployment/"$DEPLOYMENT_NAME" --timeout=120s

      - name: Trigger Auto-Promotion Workflow
        if: success()
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: k8s-deploy-success
          client-payload: |
            {
              "source": "${{ env.kustomize_path }}"
            }

name: Auto Promotion After Deployment

on:
  repository_dispatch:
    types: [k8s-deploy-success]

jobs:
  promote:
    runs-on: wsl-runner
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Detect Promotion Target
        id: detect
        shell: bash
        run: |
            # Get the source folder from repository_dispatch payload
            RAW_SOURCE="${{ github.event.client_payload.source }}"

            echo "RAW_SOURCE: $RAW_SOURCE"

            # Remove leading ./ and possible quotes
            CLEAN_SOURCE=$(echo "$RAW_SOURCE" | sed 's#^\./##' | tr -d '"')

            echo "CLEAN_SOURCE: $CLEAN_SOURCE"

            case "$CLEAN_SOURCE" in
            development)
                echo "target_branch=dev" >> $GITHUB_ENV
                ;;
            pre-releases)
                echo "target_branch=qa" >> $GITHUB_ENV
                ;;
            releases)
                echo "target_branch=prod" >> $GITHUB_ENV
                ;;
            *)
                echo "Unknown source folder: $CLEAN_SOURCE"
                exit 1
                ;;
            esac

            echo "source_dir=$CLEAN_SOURCE" >> $GITHUB_ENV


      - name: Create Promotion Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: auto-promote-${{ env.target_branch }}-${{ github.run_number }}
          base: ${{ env.target_branch }}
          title: "Auto-Promotion from ${{ env.source_dir }}"
          body: |
            Kubernetes deployment **succeeded**, triggering auto-promotion.
            Source folder: `${{ env.source_dir }}`
          commit-message: "Auto promotion from ${{ env.source_dir }} â†’ ${{ env.target_branch }}"
          add-paths: |
            ${{ env.source_dir }}/**
          labels: auto-promotion
          reviewers: Shadab
            
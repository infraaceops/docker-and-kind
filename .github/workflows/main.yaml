name: Auto Promotion Pipeline

on:
  push:
    paths:
      - "development/**"
      - "pre-releases/**"
      - "releases/**"

jobs:
  promote:
    runs-on: wsl-runner

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # ← IMPORTANT: required for diff and folder detection

      - name: Get changed files safely
        id: changes
        run: |
          git fetch --all

          # Detect changes between last two commits safely
          if [ "$(git rev-list --count HEAD)" -eq 1 ]; then
            echo "Only one commit detected, using full tree."
            git ls-files > changed.txt
          else
            git diff --name-only HEAD^ HEAD > changed.txt
          fi

          echo "Changed files:"
          cat changed.txt

      - name: Detect promotion target
        id: detect
        run: |
          TARGET_BRANCH=""
          SOURCE_DIR=""

          if grep -q "^development/" changed.txt; then
            TARGET_BRANCH="dev"
            SOURCE_DIR="development"
          fi

          if grep -q "^pre-releases/" changed.txt; then
            TARGET_BRANCH="qa"
            SOURCE_DIR="pre-releases"
          fi

          if grep -q "^releases/" changed.txt; then
            TARGET_BRANCH="prod"
            SOURCE_DIR="releases"
          fi

          if [ -z "$TARGET_BRANCH" ]; then
            echo "No promotion path matched. Exiting."
            exit 0
          fi

          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_ENV
          echo "source_dir=$SOURCE_DIR" >> $GITHUB_ENV

          echo "Promotion target: $TARGET_BRANCH from $SOURCE_DIR"

      - name: Prepare promotion files
        run: |
          mkdir promotion || true
          cp -R $source_dir/* promotion/

      - name: Create promotion Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: auto-promote-${{ env.target_branch }}-${{ github.run_number }}
          base: ${{ env.target_branch }}
          title: "Auto Promotion to ${{ env.target_branch }}"
          body: |
            Auto promotion from **${{ env.source_dir }}**.
            Triggered by changes:
            ```
            $(cat changed.txt)
            ```
          commit-message: "Auto promotion: ${{ env.source_dir }} → ${{ env.target_branch }}"
          add-paths: promotion/**
          labels: auto-promotion
          reviewers: Shadab
